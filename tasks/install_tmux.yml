---
# tasks file for ./roles/install_server

# ------------------------------------------------------------------------------
- name: "SERVER | tmux | step 1 | install dependencies"
  become: true
  ansible.builtin.apt:
    pkg: "{{ install_server_tmux.apt_dependencies }}"
    state: present
    force_apt_get: true # apt-get instead of aptitude
  tags:
    - install_server
    - tmux

# ------------------------------------------------------------------------------
- name: "SERVER | tmux | step 2 | install tmux | git clone"
  become: true
  ansible.builtin.git:
    repo: "{{ install_server_tmux.git }}"
    dest: "/opt/tmux"
    force: true
    update: "{{ install_server_tmux.update | bool }}"
    version: master
  tags:
    - install_server
    - tmux

# ------------------------------------------------------------------------------
- name: "SERVER | tmux | step 2.1 | install tmux  | run autogen.sh"
  become: true
  ansible.builtin.shell: ./autogen.sh
  args:
    chdir: "/opt/tmux"
    creates: "/opt/tmux/configure"
    executable: /bin/bash
  tags:
    - install_server
    - tmux

- name: "SERVER | tmux | step 2.2 | install tmux  | run configure"
  become: true
  ansible.builtin.shell: ./configure
  args:
    chdir: "/opt/tmux"
    creates: "/opt/tmux/Makefile"
    executable: /bin/bash
  tags:
    - install_server
    - tmux

- name: "SERVER | tmux | step 2.3 | install tmux  | make and install"
  become: true
  ansible.builtin.shell: set -o pipefail && make && make install
  args:
    chdir: "/opt/tmux"
    executable: /bin/bash
  register: tmux_make_run
  changed_when: tmux_make_run.rc != 0
  tags:
    - install_server
    - tmux

# ------------------------------------------------------------------------------
- name: "SERVER | tmux | step 3.1 | setup tmux plugins | git clone"
  become: true
  become_user: "{{ outer_item.name }}"
  ansible.builtin.git:
    repo: "{{ install_server_tmux.plugins.git }}"
    dest: "{{ install_server_tmux.plugins.path }}"
    force: true
    update: false
    version: "{{ install_server_tmux.plugins.version }}"
  tags:
    - install_server
    - tmux

# ------------------------------------------------------------------------------
- name: "SERVER | tmux | step 4.1 | setup tmux style | git clone"
  become: true
  become_user: "{{ outer_item.name }}"
  ansible.builtin.git:
    repo: "{{ install_server_tmux.style.git }}"
    dest: "{{ install_server_tmux.style.path }}"
    force: true
    update: false
    version: "{{ install_server_tmux.style.version }}"
  tags:
    - install_server
    - tmux

- name: "SERVER | tmux | step 4.2 | setup tmux style | symbolic .tmux.conf"
  become: true
  become_user: "{{ outer_item.name }}"
  ansible.builtin.file:
    src: "{{ install_server_tmux.style.path }}/.tmux.conf"
    dest: ~/.tmux.conf
    state: link
  tags:
    - install_server
    - tmux

- name: "SERVER | tmux | step 4.3 | setup tmux style | symbolic .tmux.conf.local"
  become: true
  become_user: "{{ outer_item.name }}"
  ansible.builtin.file:
    src: "{{ install_server_tmux.style.path }}/.tmux.conf.local"
    dest: ~/.tmux.conf.local
    state: link
  tags:
    - install_server
    - tmux

# ------------------------------------------------------------------------------
- name: "SERVER | tmux | step 5.1 | setup tmux style | append command to .tmux.conf.local"
  become: true
  become_user: "{{ outer_item.name }}"
  ansible.builtin.lineinfile:
    dest: "{{ install_server_tmux.style.path }}/.tmux.conf.local"
    state: present
    line: "{{ item }}"
  loop: "{{ install_server_tmux.append_config_style | flatten(levels=1) }}"
  tags:
    - install_server
    - tmux

- name: "SERVER | tmux | step 5.2 | setup tmux tpm | append command to .tmux.conf.local"
  ansible.builtin.lineinfile:
    dest: "{{ install_server_tmux.style.path }}/.tmux.conf.local"
    state: present
    insertafter: "# -- tpm ------"
    line: "{{ item }}"
  loop: "{{ install_server_tmux.append_config_tpm | flatten(levels=1) }}"
  tags:
    - install_server
    - tmux

# ------------------------------------------------------------------------------
- name: "SERVER | tmux | step 6.1.1 | create fonts folder"
  become: true
  become_user: "{{ outer_item.name }}"
  ansible.builtin.file:
    path: ~/.local/share/fonts/
    state: directory
    mode: "0754"
  tags:
    - install_server
    - tmux

# https://github.com/powerline/fonts
- name: "SERVER | tmux | step 6.1.2 | install fonts"
  become: true
  become_user: "{{ outer_item.name }}"
  ansible.builtin.get_url:
    url: "{{ item }}"
    dest: ~/.local/share/fonts/
    mode: "0664"
  loop:
    - https://raw.githubusercontent.com/powerline/fonts/master/ProFont/ProFont%20For%20Powerline.ttf
    - https://raw.githubusercontent.com/powerline/fonts/master/UbuntuMono/Ubuntu%20Mono%20derivative%20Powerline.ttf
    - https://raw.githubusercontent.com/powerline/fonts/master/SourceCodePro/Source%20Code%20Pro%20for%20Powerline.otf
  tags:
    - install_server
    - tmux
